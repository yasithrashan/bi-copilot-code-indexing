# Ballerina Code Expansion

**Query:** Modify the update books endpoint to prevent duplicate ISBNs and return a 409 Conflict error if a book with the same ISBN already exists.

---

Based on the user query and the relevant code chunks provided, I'll expand and organize the existing code to address the request. The main focus will be on modifying the update books endpoint to prevent duplicate ISBNs and return a 409 Conflict error if a book with the same ISBN already exists.

## Filename: main.bal

## Imports
```ballerina
import ballerina/http;
import ballerina/uuid;
```

## Configuration Variables
```ballerina
configurable int servicePort = 8080;
```

## Module Level Variables
```ballerina
int totalRequests = 0;
map<Book> bookStore = {};
```

## Services
```ballerina
service /bookstore on new http:Listener(servicePort) {
    // Other resources...

    // Updated books endpoint
    resource function put books/[string bookId](@http:Payload BookRequest bookRequest) returns Book|http:NotFound|http:BadRequest|http:Conflict|http:InternalServerError {
        totalRequests += 1;

        if !bookStore.hasKey(k = bookId) {
            return http:NOT_FOUND;
        }

        // Check for duplicate ISBN
        foreach var existingBook in bookStore {
            if existingBook.isbn == bookRequest.isbn && existingBook.id != bookId {
                return http:CONFLICT;
            }
        }

        Book updatedBook = {
            id: bookId,
            title: bookRequest.title,
            author: bookRequest.author,
            isbn: bookRequest.isbn,
            price: bookRequest.price,
            quantity: bookRequest.quantity
        };

        bookStore[bookId] = updatedBook;
        return updatedBook;
    }

    // Other resources...
}
```

## Resources
```ballerina
resource function post books(@http:Payload BookRequest bookRequest) returns http:Created|http:BadRequest|http:InternalServerError {
    totalRequests += 1;

    Book|error validatedBook = validateAndFormatBook(bookRequest);
    if validatedBook is error {
        return http:BAD_REQUEST;
    }

    bookStore[validatedBook.id] = validatedBook;
    return http:CREATED;
}
```

## Matching Resources
```ballerina
function validateAndFormatBook(BookRequest bookRequest) returns Book|error {
    if bookRequest.title.trim().length() == 0 {
        return error("Book title cannot be empty");
    }

    if bookRequest.author.trim().length() == 0 {
        return error("Book author cannot be empty");
    }

    if bookRequest.price < 0.0d {
        return error("Book price cannot be negative");
    }

    if bookRequest.quantity < 0 {
        return error("Book quantity cannot be negative");
    }

    string bookId = uuid:createType1AsString();

    Book validatedBook = {
        id: bookId,
        title: bookRequest.title.trim(),
        author: bookRequest.author.trim(),
        isbn: bookRequest.isbn.trim(),
        price: bookRequest.price,
        quantity: bookRequest.quantity
    };

    return validatedBook;
}
```

This expanded code addresses the user's request by modifying the update books endpoint (`put books/[string bookId]`) to check for duplicate ISBNs before updating a book. If a book with the same ISBN already exists (excluding the book being updated), it returns a 409 Conflict error. The code also includes relevant imports, configuration variables, module-level variables, and related functions to provide context for the modification.

---
