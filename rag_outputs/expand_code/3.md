# Ballerina Code Expansion

**Query:** Modify the update books endpoint to prevent duplicate ISBNs and return a 409 Conflict error if a book with the same ISBN already exists.

---

## Filename: main.bal

Imports
```ballerina
import ballerina/http;
import ballerina/uuid;
```

Configuration Variables
```ballerina
configurable int servicePort = 8080;
```

Module Level Variables
```ballerina
int totalRequests = 0;
map<Book> bookStore = {};
```

Services
```ballerina
service /bookstore on new http:Listener(servicePort) {
    // Other resources...

    // Update an existing book
    resource function put books/[string bookId](@http:Payload BookRequest bookRequest) returns Book|http:NotFound|http:BadRequest|http:Conflict|http:InternalServerError {
        totalRequests += 1;

        if !bookStore.hasKey(k = bookId) {
            return http:NOT_FOUND;
        }

        // Check for duplicate ISBN
        foreach var existingBook in bookStore {
            if existingBook.isbn == bookRequest.isbn && existingBook.id != bookId {
                return http:CONFLICT;
            }
        }

        Book updatedBook = {
            id: bookId,
            title: bookRequest.title,
            author: bookRequest.author,
            isbn: bookRequest.isbn,
            price: bookRequest.price,
            quantity: bookRequest.quantity
        };

        bookStore[bookId] = updatedBook;
        return updatedBook;
    }

    // Other resources...
}
```

Resources
```ballerina
resource function put books/[string bookId](@http:Payload BookRequest bookRequest) returns Book|http:NotFound|http:BadRequest|http:Conflict|http:InternalServerError {
    totalRequests += 1;

    if !bookStore.hasKey(k = bookId) {
        return http:NOT_FOUND;
    }

    // Check for duplicate ISBN
    foreach var existingBook in bookStore {
        if existingBook.isbn == bookRequest.isbn && existingBook.id != bookId {
            return http:CONFLICT;
        }
    }

    Book updatedBook = {
        id: bookId,
        title: bookRequest.title,
        author: bookRequest.author,
        isbn: bookRequest.isbn,
        price: bookRequest.price,
        quantity: bookRequest.quantity
    };

    bookStore[bookId] = updatedBook;
    return updatedBook;
}
```

## Filename: types.bal

```ballerina
// Book record type
public type Book record {|
    string id;
    string title;
    string author;
    string isbn;
    decimal price;
    int quantity;
|};

// Book creation request (without ID)
public type BookRequest record {|
    string title;
    string author;
    string isbn;
    decimal price;
    int quantity;
|};
```

---

*Code expansion generated from 8 relevant chunks across 2 files*
